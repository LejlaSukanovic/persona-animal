<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zgodovina ujemanja</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="/zgodovinaUjemanja.css">
  <style>
    .content {
      opacity: 0;
      transform: translateX(100%);
      transition: opacity 1s ease-out, transform 1s ease-out;
    }
    .content.visible {
      opacity: 1;
      transform: translateX(0);
    }
  </style>
</head>
<body>
  <div class="container mt-5 content">
    <h1 class="text-center mb-5">Zgodovina ujemanja</h1>

    <% const categories = {}; %>
    <% kategorije.forEach(category => { %>
      <% categories[category] = []; %>
    <% }); %>

    <% uporabniki.forEach(uporabnik => { %>
      <% Object.keys(uporabnik).forEach(key => { %>
        <% if (kategorije.includes(key)) { %>
          <% if (!categories[key]) { categories[key] = []; } %>
          <% categories[key].push(uporabnik); %>
        <% } %>
      <% }); %>
    <% }); %>

    <% Object.keys(categories).forEach(category => { %>
      <div class="category-section">
        <h2 class="text-center"><%= category %></h2>
        <% const categoryUsers = categories[category]; %>
        <% const hasValidUsers = categoryUsers.some(uporabnik => uporabnik[category] && uporabnik[category] !== '0'); %>
        <% const userHasCategory = userCategories.includes(category); %>
        
        <% if (hasValidUsers) { %>
          <div class="row">
            <% categoryUsers.forEach(uporabnik => { %>
              <% if (uporabnik[category] && uporabnik[category] !== '0') { %>
                <div class="col-md-4 col-6 mb-4">
                  <div class="card h-100 position-relative">
                    <span class="close-btn material-icons" aria-label="Delete result" onclick="confirmDelete('<%= uporabnik.idUporabnik %>', '<%= category %>')">delete</span>
                    <% 
                      const entitetaId = uporabnik[category];
                      const entiteta = entitetaMap.get(entitetaId);
                    %>
                    <div>
                      <% if (entiteta) { %>
                        <img src="<%= entiteta.slika %>" alt="<%= entiteta.naziv %>">
                      <% } else { %>
                        <p>Ni podatkov</p>
                      <% } %>
                    </div>
                    <div class="card-body text-center">
                      <h5 class="card-title">
                        <%= uporabnik.ime %>
                      </h5>
                      <div class="rating-text">
                        Ocena ujemanja: <span class="rating-circle"><%= uporabnik.ocena || '/' %></span>
                      </div>
                    </div>
                  </div>
                </div>
              <% } %>
            <% }) %>
          </div>
        <% } else { %>
          <div class="no-matches">
            <% if (userHasCategory) { %>
              <p>Nimate ujemanja za tisto kategorijo, klik na gumb ce zelite dodati novo ujemanje:</p>
              <button class="btn" onclick="clearStorageAndNavigate('<%= category %>')">Izvedi ujemanje</button>
            <% } else { %>
              <p>Nimate samoocenitev za tisto kategorijo, ce zelite narediti ujemanje, najprej naredite samoocenitev.</p>
              <button class="btn" onclick="navigateTo('/samoocenitev')">Izvedi samoocenitev</button>
            <% } %>
          </div>
        <% } %>
      </div>
    <% }); %>
  </div>
  
  <br><br><br><br><br><br>
  <footer>
    <div class="row">
        <div class="col footer-col-1" onclick="navigateTo('/samoocenitev');">Samoocenitev</div>
        <div class="col footer-col-2" onclick="navigateTo('/ujemanje');">Ujemanje</div>
    </div>
  </footer>

  <!-- Alert -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmationModalLabel">Opozorilo</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Ali ste prepričani da želite izbrisati rezultat samoocenitve?
          <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script>
          <dotlottie-player src="https://lottie.host/f16e66e9-700b-48e9-8ce5-b44a4fef96b0/LTisdNDO59.json" background="transparent" speed="1" style="width: 200px; height: 200px; padding: 0px; margin-left: 25%;" loop autoplay></dotlottie-player>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn" data-dismiss="modal">Ne</button>
          <button type="button" class="btn" id="confirmDelete">Da</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="/zgodovinaUjemanja.js"></script>
</body>
</html>
